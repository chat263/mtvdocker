(()=>{var e={};e.id=2797,e.ids=[2797],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},98216:e=>{"use strict";e.exports=require("net")},74026:e=>{"use strict";e.exports=require("string_decoder")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},6005:e=>{"use strict";e.exports=require("node:crypto")},46908:(e,t,r)=>{"use strict";r.r(t),r.d(t,{GlobalError:()=>n.a,__next_app__:()=>m,originalPathname:()=>u,pages:()=>d,routeModule:()=>p,tree:()=>c}),r(96418),r(83421),r(85673);var a=r(41118),s=r(20515),l=r(17412),n=r.n(l),o=r(35078),i={};for(let e in o)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(i[e]=()=>o[e]);r.d(t,i);let c=["",{children:["search",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(r.bind(r,96418)),"/app/src/app/search/page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(r.bind(r,83421)),"/app/src/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(r.t.bind(r,85673,23)),"next/dist/client/components/not-found-error"]}],d=["/app/src/app/search/page.tsx"],u="/search/page",m={require:r,loadChunk:()=>Promise.resolve()},p=new a.AppPageRouteModule({definition:{kind:s.x.APP_PAGE,page:"/search/page",pathname:"/search",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:c}})},7488:(e,t,r)=>{Promise.resolve().then(r.bind(r,27070))},27070:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>w});var a=r(19681),s=r(76625),l=r(35128),n=r(30648),o=r(18202),i=r(73301),c=r.n(i),d=r(73469),u=r(73953),m=r(8906);let p=(0,m.Z)("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]),x=(0,m.Z)("ArrowDownWideNarrow",[["path",{d:"m3 16 4 4 4-4",key:"1co6wj"}],["path",{d:"M7 20V4",key:"1yoxec"}],["path",{d:"M11 4h10",key:"1w87gc"}],["path",{d:"M11 8h7",key:"djye34"}],["path",{d:"M11 12h4",key:"q8tih4"}]]),g=(0,m.Z)("ArrowUpNarrowWide",[["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}],["path",{d:"M11 12h4",key:"q8tih4"}],["path",{d:"M11 16h7",key:"uosisv"}],["path",{d:"M11 20h10",key:"jvxblo"}]]);var h=r(15501);let y={source:"all",title:"all",year:"all",yearOrder:"none"},f=({categories:e,values:t,onChange:r})=>{let[s,l]=(0,i.useState)(null),[n,o]=(0,i.useState)({x:0,y:0,width:0}),c=(0,i.useRef)({}),d=(0,i.useRef)(null),u=(0,i.useMemo)(()=>({...y,...t}),[t]),m=e=>{let t=c.current[e];if(t){let r=t.getBoundingClientRect(),a=window.innerWidth,s=r.left,l=Math.max(r.width,"title"===e?400:240),n=!1;a<768&&(n=!0,s+(l=Math.min(l,a-32))>a-16&&(s=a-l-16),s<16&&(s=16)),o({x:s,y:r.bottom,width:n?l:r.width})}},f=e=>{s===e?l(null):(l(e),m(e))},b=(e,t)=>{r({...u,[e]:t}),l(null)},v=t=>{let r=e.find(e=>e.key===t);if(!r)return"";let a=u[t];if(!a||a===y[t])return r.label;let s=r.options.find(e=>e.value===a);return s?.label||r.label},k=e=>{let t=u[e];return!t||t===y[e]},w=(e,t)=>(u[e]??y[e])===t;return(0,i.useEffect)(()=>{let e=()=>{s&&l(null)},t=()=>{s&&m(s)};return document.body.addEventListener("scroll",e,{passive:!0}),window.addEventListener("resize",t),()=>{document.body.removeEventListener("scroll",e),window.removeEventListener("resize",t)}},[s]),(0,i.useEffect)(()=>{let e=e=>{!d.current||d.current.contains(e.target)||Object.values(c.current).some(t=>t&&t.contains(e.target))||l(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"relative inline-flex rounded-full p-0.5 sm:p-1 bg-transparent gap-1 sm:gap-2",children:[e.map(e=>a.jsx("div",{ref:t=>{c.current[e.key]=t},className:"relative",children:(0,a.jsxs)("button",{onClick:()=>f(e.key),className:`relative z-10 px-1.5 py-0.5 sm:px-2 sm:py-1 md:px-4 md:py-2 text-xs sm:text-sm font-medium rounded-full transition-all duration-200 whitespace-nowrap ${s===e.key?k(e.key)?"text-gray-900 dark:text-gray-100 cursor-default":"text-green-600 dark:text-green-400 cursor-default":k(e.key)?"text-gray-700 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100 cursor-pointer":"text-green-600 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300 cursor-pointer"}`,children:[a.jsx("span",{children:v(e.key)}),a.jsx("svg",{className:`inline-block w-2.5 h-2.5 sm:w-3 sm:h-3 ml-0.5 sm:ml-1 transition-transform duration-200 ${s===e.key?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})},e.key)),a.jsx("div",{className:"relative",children:(0,a.jsxs)("button",{onClick:()=>{let e;switch(u.yearOrder){case"none":default:e="desc";break;case"desc":e="asc";break;case"asc":e="none"}r({...u,yearOrder:e})},className:`relative z-10 px-1.5 py-0.5 sm:px-2 sm:py-1 md:px-4 md:py-2 text-xs sm:text-sm font-medium rounded-full transition-all duration-200 whitespace-nowrap ${"none"===u.yearOrder?"text-gray-700 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100 cursor-pointer":"text-green-600 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300 cursor-pointer"}`,"aria-label":`按年份${"none"===u.yearOrder?"排序":"desc"===u.yearOrder?"降序":"升序"}排序`,children:[a.jsx("span",{children:"年份"}),"none"===u.yearOrder?a.jsx(p,{className:"inline-block ml-1 w-4 h-4 sm:w-4 sm:h-4"}):"desc"===u.yearOrder?a.jsx(x,{className:"inline-block ml-1 w-4 h-4 sm:w-4 sm:h-4"}):a.jsx(g,{className:"inline-block ml-1 w-4 h-4 sm:w-4 sm:h-4"})]})})]}),s&&(0,h.createPortal)(a.jsx("div",{ref:d,className:"fixed z-[9999] bg-white/95 dark:bg-gray-800/95 rounded-xl border border-gray-200/50 dark:border-gray-700/50 backdrop-blur-sm max-h-[50vh] flex flex-col",style:{left:`${n.x}px`,top:`${n.y}px`,minWidth:`${Math.max(n.width,"title"===s?400:240)}px`,maxWidth:"600px",position:"fixed"},children:a.jsx("div",{className:"p-2 sm:p-4 overflow-y-auto flex-1 min-h-0",children:a.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-1 sm:gap-2",children:e.find(e=>e.key===s)?.options.map(e=>a.jsx("button",{onClick:()=>b(s,e.value),className:`px-2 py-1.5 sm:px-3 sm:py-2 text-xs sm:text-sm rounded-lg transition-all duration-200 text-left ${w(s,e.value)?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 border border-green-200 dark:border-green-700":"text-gray-700 dark:text-gray-300 hover:bg-gray-100/80 dark:hover:bg-gray-700/80"}`,children:e.label},e.value))})})}),document.body)]})};function b({query:e,isVisible:t,onSelect:r,onClose:s}){let[l,n]=(0,i.useState)([]),o=(0,i.useRef)(null),c=(0,i.useRef)(null),d=(0,i.useRef)(null),u=(0,i.useCallback)(async e=>{d.current&&d.current.abort();let t=new AbortController;d.current=t;try{let r=await fetch(`/api/search/suggestions?q=${encodeURIComponent(e)}`,{signal:t.signal});if(r.ok){let e=(await r.json()).suggestions.map(e=>({text:e.text,type:"related"}));n(e)}}catch(e){e instanceof Error?"AbortError"!==e.name&&n([]):n([])}},[]);return((0,i.useCallback)(e=>{c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{e.trim()&&t?u(e):n([])},300)},[t,u]),t&&0!==l.length)?a.jsx("div",{ref:o,className:"absolute top-full left-0 right-0 z-50 mt-1 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 max-h-80 overflow-y-auto",children:l.map(e=>a.jsx("button",{onClick:()=>r(e.text),className:"w-full px-4 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150 flex items-center gap-3",children:a.jsx("span",{className:"flex-1 text-sm text-gray-700 dark:text-gray-300 truncate",children:e.text})},`related-${e.text}`))}):null}var v=r(52272);function k(){let[e,t]=(0,i.useState)([]),[r,m]=(0,i.useState)(!1),p=(0,o.useRouter)();(0,o.useSearchParams)(),(0,i.useRef)("");let[x,g]=(0,i.useState)(""),[h,y]=(0,i.useState)(!1),[k,w]=(0,i.useState)(!1),[j,N]=(0,i.useState)([]),[C,M]=(0,i.useState)(!1);(0,i.useRef)(null);let[_,q]=(0,i.useState)(0),[S,$]=(0,i.useState)(0);(0,i.useRef)([]),(0,i.useRef)(null);let[R,A]=(0,i.useState)(!0),E=(0,i.useRef)(new Map),P=(0,i.useRef)(new Map),O=e=>{let t=E.current.get(e);return t||(t=c().createRef(),E.current.set(e,t)),t},I=e=>({episodes:(()=>{let t=new Map;e.forEach(e=>{let r=e.episodes?.length||0;r>0&&t.set(r,(t.get(r)||0)+1)});let r=0,a=0;return t.forEach((e,t)=>{e>r&&(r=e,a=t)}),a})(),source_names:Array.from(new Set(e.map(e=>e.source_name).filter(Boolean)))}),[Z,L]=(0,i.useState)({source:"all",title:"all",year:"all",yearOrder:"none"}),[z,U]=(0,i.useState)({source:"all",title:"all",year:"all",yearOrder:"none"}),W=()=>!0,[T,D]=(0,i.useState)(()=>W()?"agg":"all"),G=(e,t,r)=>{if("none"===r)return 0;let a=!e||"unknown"===e,s=!t||"unknown"===t;if(a&&s)return 0;if(a)return 1;if(s)return -1;let l=parseInt(e,10),n=parseInt(t,10);return"asc"===r?l-n:n-l},B=(0,i.useMemo)(()=>{let e=new Map,t=[];return j.forEach(r=>{let a=`${r.title.replaceAll(" ","")}-${r.year||"unknown"}-${1===r.episodes.length?"movie":"tv"}`,s=e.get(a)||[];0===s.length&&t.push(a),s.push(r),e.set(a,s)}),t.map(t=>[t,e.get(t)])},[j]),V=(0,i.useMemo)(()=>{let e=new Map,t=new Set,r=new Set;j.forEach(a=>{a.source&&a.source_name&&e.set(a.source,a.source_name),a.title&&t.add(a.title),a.year&&r.add(a.year)});let a=[{label:"全部来源",value:"all"},...Array.from(e.entries()).sort((e,t)=>e[1].localeCompare(t[1])).map(([e,t])=>({label:t,value:e}))],s=[{label:"全部标题",value:"all"},...Array.from(t.values()).sort((e,t)=>e.localeCompare(t)).map(e=>({label:e,value:e}))],l=Array.from(r.values()),n=l.filter(e=>"unknown"!==e).sort((e,t)=>parseInt(t)-parseInt(e)),o=l.includes("unknown"),i=[{label:"全部年份",value:"all"},...n.map(e=>({label:e,value:e})),...o?[{label:"未知",value:"unknown"}]:[]];return{categoriesAll:[{key:"source",label:"来源",options:a},{key:"title",label:"标题",options:s},{key:"year",label:"年份",options:i}],categoriesAgg:[{key:"source",label:"来源",options:a},{key:"title",label:"标题",options:s},{key:"year",label:"年份",options:i}]}},[j]),F=(0,i.useMemo)(()=>{let{source:e,title:t,year:r,yearOrder:a}=Z,s=j.filter(a=>("all"===e||a.source===e)&&("all"===t||a.title===t)&&("all"===r||a.year===r));return"none"===a?s:s.sort((e,t)=>{let r=G(e.year,t.year,a);if(0!==r)return r;let s=e.title===x.trim(),l=t.title===x.trim();return s&&!l?-1:!s&&l?1:"asc"===a?e.title.localeCompare(t.title):t.title.localeCompare(e.title)})},[j,Z,x]),X=(0,i.useMemo)(()=>{let{source:e,title:t,year:r,yearOrder:a}=z,s=B.filter(([a,s])=>{let l=s[0]?.title??"",n=s[0]?.year??"unknown";return!!("all"===e||s.some(t=>t.source===e))&&("all"===t||l===t)&&("all"===r||n===r)});return"none"===a?s:s.sort((e,t)=>{let r=G(e[1][0].year,t[1][0].year,a);if(0!==r)return r;let s=e[1][0].title===x.trim(),l=t[1][0].title===x.trim();if(s&&!l)return -1;if(!s&&l)return 1;let n=e[1][0].title,o=t[1][0].title;return"asc"===a?n.localeCompare(o):o.localeCompare(n)})},[B,z,x]);return(0,a.jsxs)(u.Z,{activePath:"/search",children:[(0,a.jsxs)("div",{className:"px-4 sm:px-10 py-4 sm:py-8 overflow-visible mb-10",children:[a.jsx("div",{className:"mb-8",children:a.jsx("form",{onSubmit:e=>{e.preventDefault();let t=x.trim().replace(/\s+/g," ");t&&(g(t),y(!0),w(!0),M(!1),p.push(`/search?q=${encodeURIComponent(t)}`))},className:"max-w-2xl mx-auto",children:(0,a.jsxs)("div",{className:"relative",children:[a.jsx(s.Z,{className:"absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400 dark:text-gray-500"}),a.jsx("input",{id:"searchInput",type:"text",value:x,onChange:e=>{let t=e.target.value;g(t),t.trim()?M(!0):M(!1)},onFocus:()=>{x.trim()&&M(!0)},placeholder:"搜索电影、电视剧...",className:"w-full h-12 rounded-lg bg-gray-50/80 py-3 pl-10 pr-4 text-sm text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400 focus:bg-white border border-gray-200/50 shadow-sm dark:bg-gray-800 dark:text-gray-300 dark:placeholder-gray-500 dark:focus:bg-gray-700 dark:border-gray-700"}),a.jsx(b,{query:x,isVisible:C,onSelect:e=>{g(e),M(!1),y(!0),w(!0),p.push(`/search?q=${encodeURIComponent(e)}`)},onClose:()=>M(!1)})]})})}),a.jsx("div",{className:"max-w-[95%] mx-auto mt-12 overflow-visible",children:k?(0,a.jsxs)("section",{className:"mb-12",children:[a.jsx("div",{className:"mb-4",children:(0,a.jsxs)("h2",{className:"text-xl font-bold text-gray-800 dark:text-gray-200",children:["搜索结果",j.length>0&&_>0&&R&&(0,a.jsxs)("span",{className:"ml-2 text-sm font-normal text-gray-500 dark:text-gray-400",children:[S,"/",_]}),j.length>0&&h&&R&&a.jsx("span",{className:"ml-2 inline-block align-middle",children:a.jsx("span",{className:"inline-block h-3 w-3 border-2 border-gray-300 border-t-green-500 rounded-full animate-spin"})})]})}),(0,a.jsxs)("div",{className:"mb-8 flex items-center justify-between gap-3",children:[a.jsx("div",{className:"flex-1 min-w-0",children:"agg"===T?a.jsx(f,{categories:V.categoriesAgg,values:z,onChange:e=>U(e)}):a.jsx(f,{categories:V.categoriesAll,values:Z,onChange:e=>L(e)})}),(0,a.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer select-none shrink-0",children:[a.jsx("span",{className:"text-xs sm:text-sm text-gray-700 dark:text-gray-300",children:"聚合"}),(0,a.jsxs)("div",{className:"relative",children:[a.jsx("input",{type:"checkbox",className:"sr-only peer",checked:"agg"===T,onChange:()=>D("agg"===T?"all":"agg")}),a.jsx("div",{className:"w-9 h-5 bg-gray-300 rounded-full peer-checked:bg-green-500 transition-colors dark:bg-gray-600"}),a.jsx("div",{className:"absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-4"})]})]})]}),0===j.length?h?a.jsx("div",{className:"flex justify-center items-center h-40",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"})}):a.jsx("div",{className:"text-center text-gray-500 py-8 dark:text-gray-400",children:"未找到相关结果"}):a.jsx("div",{className:"justify-start grid grid-cols-3 gap-x-2 gap-y-14 sm:gap-y-20 px-0 sm:px-2 sm:grid-cols-[repeat(auto-fill,_minmax(11rem,_1fr))] sm:gap-x-8",children:"agg"===T?X.map(([e,t])=>{let r=t[0]?.title||"",s=t[0]?.poster||"",l=t[0]?.year||"unknown",{episodes:n,source_names:o}=I(t),i=1===n?"movie":"tv";return P.current.has(e)||P.current.set(e,{episodes:n,source_names:o}),a.jsx("div",{className:"w-full",children:a.jsx(v.Z,{ref:O(e),from:"search",isAggregate:!0,title:r,poster:s,year:l,episodes:n,source_names:o,query:x.trim()!==r?x.trim():"",type:i})},`agg-${e}`)}):F.map(e=>a.jsx("div",{className:"w-full",children:a.jsx(v.Z,{id:e.id,title:e.title,poster:e.poster,episodes:e.episodes.length,source:e.source,source_name:e.source_name,douban_id:e.douban_id,query:x.trim()!==e.title?x.trim():"",year:e.year,from:"search",type:e.episodes.length>1?"tv":"movie"})},`all-${e.source}-${e.id}`))},`search-results-${T}`)]}):e.length>0?(0,a.jsxs)("section",{className:"mb-12",children:[(0,a.jsxs)("h2",{className:"mb-4 text-xl font-bold text-gray-800 text-left dark:text-gray-200",children:["搜索历史",e.length>0&&a.jsx("button",{onClick:()=>{(0,d.Ev)()},className:"ml-3 text-sm text-gray-500 hover:text-red-500 transition-colors dark:text-gray-400 dark:hover:text-red-500",children:"清空"})]}),a.jsx("div",{className:"flex flex-wrap gap-2",children:e.map(e=>(0,a.jsxs)("div",{className:"relative group",children:[a.jsx("button",{onClick:()=>{g(e),p.push(`/search?q=${encodeURIComponent(e.trim())}`)},className:"px-4 py-2 bg-gray-500/10 hover:bg-gray-300 rounded-full text-sm text-gray-700 transition-colors duration-200 dark:bg-gray-700/50 dark:hover:bg-gray-600 dark:text-gray-300",children:e}),a.jsx("button",{"aria-label":"删除搜索历史",onClick:t=>{t.stopPropagation(),t.preventDefault(),(0,d.Rw)(e)},className:"absolute -top-1 -right-1 w-4 h-4 opacity-0 group-hover:opacity-100 bg-gray-400 hover:bg-red-500 text-white rounded-full flex items-center justify-center text-[10px] transition-colors",children:a.jsx(l.Z,{className:"w-3 h-3"})})]},e))})]}):null})]}),a.jsx("button",{onClick:()=>{try{document.body.scrollTo({top:0,behavior:"smooth"})}catch(e){document.body.scrollTop=0}},className:`fixed bottom-20 md:bottom-6 right-6 z-[500] w-12 h-12 bg-green-500/90 hover:bg-green-500 text-white rounded-full shadow-lg backdrop-blur-sm transition-all duration-300 ease-in-out flex items-center justify-center group ${r?"opacity-100 translate-y-0 pointer-events-auto":"opacity-0 translate-y-4 pointer-events-none"}`,"aria-label":"返回顶部",children:a.jsx(n.Z,{className:"w-6 h-6 transition-transform group-hover:scale-110"})})]})}function w(){return a.jsx(i.Suspense,{children:a.jsx(k,{})})}},96418:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>a});let a=(0,r(15761).createProxy)(String.raw`/app/src/app/search/page.tsx#default`)}};var t=require("../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[677,9864,6981,9825,8013,2158,7690,2957,8300,1723,2272],()=>r(46908));module.exports=a})();