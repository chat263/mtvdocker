"use strict";(()=>{var e={};e.id=5740,e.ids=[5740],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},98216:e=>{e.exports=require("net")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6005:e=>{e.exports=require("node:crypto")},20491:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>C,patchFetch:()=>S,requestAsyncStorage:()=>y,routeModule:()=>d,serverHooks:()=>A,staticGenerationAsyncStorage:()=>h});var o={};r.r(o),r.d(o,{POST:()=>g,runtime:()=>c});var n=r(4762),s=r(20515),a=r(4894),i=r(40379),p=r(13303),u=r(35737);let c="nodejs",l=process.env.NEXT_PUBLIC_STORAGE_TYPE||"localstorage";async function f(e,t){let r=new TextEncoder,o=r.encode(t),n=r.encode(e),s=await crypto.subtle.importKey("raw",o,{name:"HMAC",hash:"SHA-256"},!1,["sign"]);return Array.from(new Uint8Array(await crypto.subtle.sign("HMAC",s,n))).map(e=>e.toString(16).padStart(2,"0")).join("")}async function m(e,t,r,o=!1){let n={role:r||"user"};if(o&&t&&(n.password=t),e&&process.env.PASSWORD){n.username=e;let t=await f(e,process.env.PASSWORD);n.signature=t,n.timestamp=Date.now()}return encodeURIComponent(JSON.stringify(n))}async function g(e){try{if("localstorage"===l){let t=process.env.PASSWORD;if(!t){let e=i.NextResponse.json({ok:!0});return e.cookies.set("auth","",{path:"/",expires:new Date(0),sameSite:"lax",httpOnly:!1,secure:!1}),e}let{password:r}=await e.json();if("string"!=typeof r)return i.NextResponse.json({error:"密码不能为空"},{status:400});if(r!==t)return i.NextResponse.json({ok:!1,error:"密码错误"},{status:401});let o=i.NextResponse.json({ok:!0}),n=await m(void 0,r,"user",!0),s=new Date;return s.setDate(s.getDate()+7),o.cookies.set("auth",n,{path:"/",expires:s,sameSite:"lax",httpOnly:!1,secure:!1}),o}let{username:t,password:r}=await e.json();if(!t||"string"!=typeof t)return i.NextResponse.json({error:"用户名不能为空"},{status:400});if(!r||"string"!=typeof r)return i.NextResponse.json({error:"密码不能为空"},{status:400});if(t===process.env.USERNAME&&r===process.env.PASSWORD){let e=i.NextResponse.json({ok:!0}),o=await m(t,r,"owner",!1),n=new Date;return n.setDate(n.getDate()+7),e.cookies.set("auth",o,{path:"/",expires:n,sameSite:"lax",httpOnly:!1,secure:!1}),e}if(t===process.env.USERNAME)return i.NextResponse.json({error:"用户名或密码错误"},{status:401});let o=(await (0,p.iE)()).UserConfig.Users.find(e=>e.username===t);if(o&&o.banned)return i.NextResponse.json({error:"用户被封禁"},{status:401});try{if(!await u.db.verifyUser(t,r))return i.NextResponse.json({error:"用户名或密码错误"},{status:401});let e=i.NextResponse.json({ok:!0}),n=await m(t,r,o?.role||"user",!1),s=new Date;return s.setDate(s.getDate()+7),e.cookies.set("auth",n,{path:"/",expires:s,sameSite:"lax",httpOnly:!1,secure:!1}),e}catch(e){return console.error("数据库验证失败",e),i.NextResponse.json({error:"数据库错误"},{status:500})}}catch(e){return console.error("登录接口异常",e),i.NextResponse.json({error:"服务器错误"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/login/route",pathname:"/api/login",filename:"route",bundlePath:"app/api/login/route"},resolvedPagePath:"/app/src/app/api/login/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:A}=d,C="/api/login/route";function S(){return(0,a.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:h})}},13303:(e,t,r)=>{let o;r.d(t,{Hz:()=>s,Ih:()=>u,iE:()=>p,jT:()=>c,ll:()=>l,mL:()=>a});var n=r(35737);let s={search:{path:"?ac=videolist&wd=",pagePath:"?ac=videolist&wd={query}&pg={page}",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json"}},detail:{path:"?ac=videolist&ids=",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json"}}};function a(e){let t;try{t=JSON.parse(e.ConfigFile)}catch(e){t={}}let r=Object.entries(t.api_site||[]),o=new Map((e.SourceConfig||[]).map(e=>[e.key,e]));r.forEach(([e,t])=>{let r=o.get(e);r?(r.name=t.name,r.api=t.api,r.detail=t.detail,r.from="config"):o.set(e,{key:e,name:t.name,api:t.api,detail:t.detail,from:"config",disabled:!1})});let n=new Set(r.map(([e])=>e));o.forEach(e=>{n.has(e.key)||(e.from="custom")}),e.SourceConfig=Array.from(o.values());let s=t.custom_category||[],a=new Map((e.CustomCategories||[]).map(e=>[e.query+e.type,e]));s.forEach(e=>{let t=e.query+e.type,r=a.get(t);r?(r.name=e.name,r.query=e.query,r.type=e.type,r.from="config"):a.set(t,{name:e.name,type:e.type,query:e.query,from:"config",disabled:!1})});let i=new Set(s.map(e=>e.query+e.type));return a.forEach(e=>{i.has(e.query+e.type)||(e.from="custom")}),e.CustomCategories=Array.from(a.values()),e}async function i(e,t={URL:"",AutoUpdate:!1,LastCheck:""}){let r;try{r=JSON.parse(e)}catch(e){r={}}let o={ConfigFile:e,ConfigSubscribtion:t,SiteConfig:{SiteName:process.env.NEXT_PUBLIC_SITE_NAME||"MoonTV",Announcement:process.env.ANNOUNCEMENT||"本网站仅提供影视信息搜索服务，所有内容均来自第三方网站。本站不存储任何视频资源，不对任何内容的准确性、合法性、完整性负责。",SearchDownstreamMaxPage:Number(process.env.NEXT_PUBLIC_SEARCH_MAX_PAGE)||5,SiteInterfaceCacheTime:r.cache_time||7200,DoubanProxyType:process.env.NEXT_PUBLIC_DOUBAN_PROXY_TYPE||"direct",DoubanProxy:process.env.NEXT_PUBLIC_DOUBAN_PROXY||"",DoubanImageProxyType:process.env.NEXT_PUBLIC_DOUBAN_IMAGE_PROXY_TYPE||"direct",DoubanImageProxy:process.env.NEXT_PUBLIC_DOUBAN_IMAGE_PROXY||"",DisableYellowFilter:"true"===process.env.NEXT_PUBLIC_DISABLE_YELLOW_FILTER},UserConfig:{AllowRegister:"true"===process.env.NEXT_PUBLIC_ENABLE_REGISTER,Users:[]},SourceConfig:[],CustomCategories:[]},s=(0,n.cF)(),a=[];if(s&&"function"==typeof s.getAllUsers)try{a=await s.getAllUsers()}catch(e){console.error("获取用户列表失败:",e)}let i=a.filter(e=>e!==process.env.USERNAME).map(e=>({username:e,role:"user",banned:!1}));return i.unshift({username:process.env.USERNAME,role:"owner",banned:!1}),o.UserConfig.Users=i,Object.entries(r.api_site||[]).forEach(([e,t])=>{o.SourceConfig.push({key:e,name:t.name,api:t.api,detail:t.detail,from:"config",disabled:!1})}),r.custom_category?.forEach(e=>{o.CustomCategories.push({name:e.name||e.query,type:e.type,query:e.query,from:"config",disabled:!1})}),o}async function p(){if(o)return o;let e=(0,n.cF)(),t=null;return e&&"function"==typeof e.getAdminConfig&&(t=await e.getAdminConfig()),t||(t=await i("")),o=t}async function u(){let e;let t=(0,n.cF)();e=t&&"function"==typeof t.getAdminConfig?await t.getAdminConfig():{};let r=await i(e.ConfigFile,e.ConfigSubscribtion);o=r,t&&"function"==typeof t.setAdminConfig&&await t.setAdminConfig(r)}async function c(){return(await p()).SiteConfig.SiteInterfaceCacheTime||7200}async function l(){return(await p()).SourceConfig.filter(e=>!e.disabled).map(e=>({key:e.key,name:e.name,api:e.api,detail:e.detail}))}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[7796,9864,3001,5737],()=>r(20491));module.exports=o})();