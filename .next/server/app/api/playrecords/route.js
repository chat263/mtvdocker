"use strict";(()=>{var e={};e.id=9633,e.ids=[9633],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},98216:e=>{e.exports=require("net")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6005:e=>{e.exports=require("node:crypto")},81899:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>h,patchFetch:()=>N,requestAsyncStorage:()=>g,routeModule:()=>y,serverHooks:()=>E,staticGenerationAsyncStorage:()=>C});var n={};t.r(n),t.d(n,{DELETE:()=>m,GET:()=>d,POST:()=>f,runtime:()=>p});var s=t(4762),a=t(20515),o=t(4894),i=t(40379),u=t(46307),l=t(13303),c=t(35737);let p="nodejs";async function d(e){try{let r=(0,u.l)(e);if(!r||!r.username)return i.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,l.iE)();if(t.UserConfig.Users){let e=t.UserConfig.Users.find(e=>e.username===r.username);if(e&&e.banned)return i.NextResponse.json({error:"用户已被封禁"},{status:401})}let n=await c.db.getAllPlayRecords(r.username);return i.NextResponse.json(n,{status:200})}catch(e){return console.error("获取播放记录失败",e),i.NextResponse.json({error:"Internal Server Error"},{status:500})}}async function f(e){try{let r=(0,u.l)(e);if(!r||!r.username)return i.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,l.iE)();if(t.UserConfig.Users){let e=t.UserConfig.Users.find(e=>e.username===r.username);if(e&&e.banned)return i.NextResponse.json({error:"用户已被封禁"},{status:401})}let{key:n,record:s}=await e.json();if(!n||!s)return i.NextResponse.json({error:"Missing key or record"},{status:400});if(!s.title||!s.source_name||s.index<1)return i.NextResponse.json({error:"Invalid record data"},{status:400});let[a,o]=n.split("+");if(!a||!o)return i.NextResponse.json({error:"Invalid key format"},{status:400});let p={...s,save_time:s.save_time??Date.now()};return await c.db.savePlayRecord(r.username,a,o,p),i.NextResponse.json({success:!0},{status:200})}catch(e){return console.error("保存播放记录失败",e),i.NextResponse.json({error:"Internal Server Error"},{status:500})}}async function m(e){try{let r=(0,u.l)(e);if(!r||!r.username)return i.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,l.iE)();if(t.UserConfig.Users){let e=t.UserConfig.Users.find(e=>e.username===r.username);if(e&&e.banned)return i.NextResponse.json({error:"用户已被封禁"},{status:401})}let n=r.username,{searchParams:s}=new URL(e.url),a=s.get("key");if(a){let[e,r]=a.split("+");if(!e||!r)return i.NextResponse.json({error:"Invalid key format"},{status:400});await c.db.deletePlayRecord(n,e,r)}else{let e=await c.db.getAllPlayRecords(n);await Promise.all(Object.keys(e).map(async e=>{let[r,t]=e.split("+");r&&t&&await c.db.deletePlayRecord(n,r,t)}))}return i.NextResponse.json({success:!0},{status:200})}catch(e){return console.error("删除播放记录失败",e),i.NextResponse.json({error:"Internal Server Error"},{status:500})}}let y=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/playrecords/route",pathname:"/api/playrecords",filename:"route",bundlePath:"app/api/playrecords/route"},resolvedPagePath:"/app/src/app/api/playrecords/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:C,serverHooks:E}=y,h="/api/playrecords/route";function N(){return(0,o.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:C})}},46307:(e,r,t)=>{function n(e){let r=e.cookies.get("auth");if(!r)return null;try{let e=decodeURIComponent(r.value);return JSON.parse(e)}catch(e){return null}}t.d(r,{l:()=>n})},13303:(e,r,t)=>{let n;t.d(r,{Hz:()=>a,Ih:()=>l,iE:()=>u,jT:()=>c,ll:()=>p,mL:()=>o});var s=t(35737);let a={search:{path:"?ac=videolist&wd=",pagePath:"?ac=videolist&wd={query}&pg={page}",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json"}},detail:{path:"?ac=videolist&ids=",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json"}}};function o(e){let r;try{r=JSON.parse(e.ConfigFile)}catch(e){r={}}let t=Object.entries(r.api_site||[]),n=new Map((e.SourceConfig||[]).map(e=>[e.key,e]));t.forEach(([e,r])=>{let t=n.get(e);t?(t.name=r.name,t.api=r.api,t.detail=r.detail,t.from="config"):n.set(e,{key:e,name:r.name,api:r.api,detail:r.detail,from:"config",disabled:!1})});let s=new Set(t.map(([e])=>e));n.forEach(e=>{s.has(e.key)||(e.from="custom")}),e.SourceConfig=Array.from(n.values());let a=r.custom_category||[],o=new Map((e.CustomCategories||[]).map(e=>[e.query+e.type,e]));a.forEach(e=>{let r=e.query+e.type,t=o.get(r);t?(t.name=e.name,t.query=e.query,t.type=e.type,t.from="config"):o.set(r,{name:e.name,type:e.type,query:e.query,from:"config",disabled:!1})});let i=new Set(a.map(e=>e.query+e.type));return o.forEach(e=>{i.has(e.query+e.type)||(e.from="custom")}),e.CustomCategories=Array.from(o.values()),e}async function i(e,r={URL:"",AutoUpdate:!1,LastCheck:""}){let t;try{t=JSON.parse(e)}catch(e){t={}}let n={ConfigFile:e,ConfigSubscribtion:r,SiteConfig:{SiteName:process.env.NEXT_PUBLIC_SITE_NAME||"MoonTV",Announcement:process.env.ANNOUNCEMENT||"本网站仅提供影视信息搜索服务，所有内容均来自第三方网站。本站不存储任何视频资源，不对任何内容的准确性、合法性、完整性负责。",SearchDownstreamMaxPage:Number(process.env.NEXT_PUBLIC_SEARCH_MAX_PAGE)||5,SiteInterfaceCacheTime:t.cache_time||7200,DoubanProxyType:process.env.NEXT_PUBLIC_DOUBAN_PROXY_TYPE||"direct",DoubanProxy:process.env.NEXT_PUBLIC_DOUBAN_PROXY||"",DoubanImageProxyType:process.env.NEXT_PUBLIC_DOUBAN_IMAGE_PROXY_TYPE||"direct",DoubanImageProxy:process.env.NEXT_PUBLIC_DOUBAN_IMAGE_PROXY||"",DisableYellowFilter:"true"===process.env.NEXT_PUBLIC_DISABLE_YELLOW_FILTER},UserConfig:{AllowRegister:"true"===process.env.NEXT_PUBLIC_ENABLE_REGISTER,Users:[]},SourceConfig:[],CustomCategories:[]},a=(0,s.cF)(),o=[];if(a&&"function"==typeof a.getAllUsers)try{o=await a.getAllUsers()}catch(e){console.error("获取用户列表失败:",e)}let i=o.filter(e=>e!==process.env.USERNAME).map(e=>({username:e,role:"user",banned:!1}));return i.unshift({username:process.env.USERNAME,role:"owner",banned:!1}),n.UserConfig.Users=i,Object.entries(t.api_site||[]).forEach(([e,r])=>{n.SourceConfig.push({key:e,name:r.name,api:r.api,detail:r.detail,from:"config",disabled:!1})}),t.custom_category?.forEach(e=>{n.CustomCategories.push({name:e.name||e.query,type:e.type,query:e.query,from:"config",disabled:!1})}),n}async function u(){if(n)return n;let e=(0,s.cF)(),r=null;return e&&"function"==typeof e.getAdminConfig&&(r=await e.getAdminConfig()),r||(r=await i("")),n=r}async function l(){let e;let r=(0,s.cF)();e=r&&"function"==typeof r.getAdminConfig?await r.getAdminConfig():{};let t=await i(e.ConfigFile,e.ConfigSubscribtion);n=t,r&&"function"==typeof r.setAdminConfig&&await r.setAdminConfig(t)}async function c(){return(await u()).SiteConfig.SiteInterfaceCacheTime||7200}async function p(){return(await u()).SourceConfig.filter(e=>!e.disabled).map(e=>({key:e.key,name:e.name,api:e.api,detail:e.detail}))}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[7796,9864,3001,5737],()=>t(81899));module.exports=n})();