"use strict";(()=>{var e={};e.id=4510,e.ids=[4510],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},98216:e=>{e.exports=require("net")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},8082:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>v,patchFetch:()=>R,requestAsyncStorage:()=>y,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>x});var s={};t.r(s),t.d(s,{POST:()=>m});var a=t(4762),o=t(20515),i=t(4894),n=t(40379),p=t(21764),u=t(71568),c=t(46307),d=t(35418),l=t(35737);let f=(0,p.promisify)(u.gunzip);async function m(e){try{let r,t;let s=process.env.NEXT_PUBLIC_STORAGE_TYPE||"localstorage";if("localstorage"===s)return n.NextResponse.json({error:"不支持本地存储进行数据迁移"},{status:400});let a=(0,c.l)(e);if(!a||!a.username)return n.NextResponse.json({error:"未登录"},{status:401});if(a.username!==process.env.USERNAME)return n.NextResponse.json({error:"权限不足，只有站长可以导入数据"},{status:401});let o=await e.formData(),i=o.get("file"),p=o.get("password");if(!i)return n.NextResponse.json({error:"请选择备份文件"},{status:400});if(!p)return n.NextResponse.json({error:"请提供解密密码"},{status:400});let u=await i.text();try{r=d.D.decrypt(u,p)}catch(e){return n.NextResponse.json({error:"解密失败，请检查密码是否正确"},{status:400})}let m=Buffer.from(r,"base64"),g=(await f(m)).toString();try{t=JSON.parse(g)}catch(e){return n.NextResponse.json({error:"备份文件格式错误"},{status:400})}if(!t.data||!t.data.adminConfig||!t.data.userData)return n.NextResponse.json({error:"备份文件格式无效"},{status:400});await l.db.clearAllData(),await l.db.saveAdminConfig(t.data.adminConfig);let y=t.data.userData;for(let e in y){let r=y[e];if(r.password&&await l.db.registerUser(e,r.password),r.playRecords)for(let[t,s]of Object.entries(r.playRecords))await l.db.storage.setPlayRecord(e,t,s);if(r.favorites)for(let[t,s]of Object.entries(r.favorites))await l.db.storage.setFavorite(e,t,s);if(r.searchHistory&&Array.isArray(r.searchHistory))for(let t of r.searchHistory.reverse())await l.db.addSearchHistory(e,t);if(r.skipConfigs)for(let[t,s]of Object.entries(r.skipConfigs)){let[r,a]=t.split("+");r&&a&&await l.db.setSkipConfig(e,r,a,s)}}return n.NextResponse.json({message:"数据导入成功",importedUsers:Object.keys(y).length,timestamp:t.timestamp,serverVersion:"string"==typeof t.serverVersion?t.serverVersion:"未知版本"})}catch(e){return console.error("数据导入失败:",e),n.NextResponse.json({error:e instanceof Error?e.message:"导入失败"},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/data_migration/import/route",pathname:"/api/admin/data_migration/import",filename:"route",bundlePath:"app/api/admin/data_migration/import/route"},resolvedPagePath:"/app/src/app/api/admin/data_migration/import/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:x,serverHooks:h}=g,v="/api/admin/data_migration/import/route";function R(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:x})}},46307:(e,r,t)=>{function s(e){let r=e.cookies.get("auth");if(!r)return null;try{let e=decodeURIComponent(r.value);return JSON.parse(e)}catch(e){return null}}t.d(r,{l:()=>s})},35418:(e,r,t)=>{t.d(r,{D:()=>o});var s=t(2178),a=t.n(s);class o{static encrypt(e,r){try{return a().AES.encrypt(e,r).toString()}catch(e){throw Error("加密失败")}}static decrypt(e,r){try{let t=a().AES.decrypt(e,r).toString(a().enc.Utf8);if(!t)throw Error("解密失败，请检查密码是否正确");return t}catch(e){throw Error("解密失败，请检查密码是否正确")}}static canDecrypt(e,r){try{return this.decrypt(e,r).length>0}catch{return!1}}}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[7796,9864,3001,2178,5737],()=>t(8082));module.exports=s})();