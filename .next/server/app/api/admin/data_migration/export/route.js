"use strict";(()=>{var t={};t.id=2796,t.ids=[2796],t.modules={20399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:t=>{t.exports=require("crypto")},17702:t=>{t.exports=require("events")},98216:t=>{t.exports=require("net")},74026:t=>{t.exports=require("string_decoder")},82452:t=>{t.exports=require("tls")},17360:t=>{t.exports=require("url")},21764:t=>{t.exports=require("util")},71568:t=>{t.exports=require("zlib")},6005:t=>{t.exports=require("node:crypto")},96765:(t,e,r)=>{r.r(e),r.d(e,{originalPathname:()=>v,patchFetch:()=>R,requestAsyncStorage:()=>y,routeModule:()=>x,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{POST:()=>S});var n=r(4762),o=r(20515),s=r(4894),i=r(40379),p=r(21764),u=r(71568),c=r(46307),l=r(35418),d=r(97690),g=r(31305);let m=(0,p.promisify)(u.gzip);async function S(t){try{let e=process.env.NEXT_PUBLIC_STORAGE_TYPE||"localstorage";if("localstorage"===e)return i.NextResponse.json({error:"不支持本地存储进行数据迁移"},{status:400});let r=(0,c.l)(t);if(!r||!r.username)return i.NextResponse.json({error:"未登录"},{status:401});if(r.username!==process.env.USERNAME)return i.NextResponse.json({error:"权限不足，只有站长可以导出数据"},{status:401});let a=await d.db.getAdminConfig();if(!a)return i.NextResponse.json({error:"无法获取配置"},{status:500});let{password:n}=await t.json();if(!n||"string"!=typeof n)return i.NextResponse.json({error:"请提供加密密码"},{status:400});let o={timestamp:new Date().toISOString(),serverVersion:g.w,data:{adminConfig:a,userData:{}}},s=await d.db.getAllUsers();for(let t of(s.push(process.env.USERNAME),s=Array.from(new Set(s)))){let e={playRecords:await d.db.getAllPlayRecords(t),favorites:await d.db.getAllFavorites(t),searchHistory:await d.db.getSearchHistory(t),skipConfigs:await d.db.getAllSkipConfigs(t),password:await f(t)};o.data.userData[t]=e}o.data.userData[process.env.USERNAME].password=process.env.PASSWORD;let p=JSON.stringify(o),u=await m(p),S=l.D.encrypt(u.toString("base64"),n),x=new Date,y=`${x.getFullYear()}${String(x.getMonth()+1).padStart(2,"0")}${String(x.getDate()).padStart(2,"0")}-${String(x.getHours()).padStart(2,"0")}${String(x.getMinutes()).padStart(2,"0")}${String(x.getSeconds()).padStart(2,"0")}`,h=`moontv-backup-${y}.dat`;return new i.NextResponse(S,{status:200,headers:{"Content-Type":"application/octet-stream","Content-Disposition":`attachment; filename="${h}"`,"Content-Length":S.length.toString()}})}catch(t){return console.error("数据导出失败:",t),i.NextResponse.json({error:t instanceof Error?t.message:"导出失败"},{status:500})}}async function f(t){try{let e=d.db.storage;if(e&&"function"==typeof e.client?.get){let r=`u:${t}:pwd`;return await e.client.get(r)}return null}catch(e){return console.error(`获取用户 ${t} 密码失败:`,e),null}}let x=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/data_migration/export/route",pathname:"/api/admin/data_migration/export",filename:"route",bundlePath:"app/api/admin/data_migration/export/route"},resolvedPagePath:"/app/src/app/api/admin/data_migration/export/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:w}=x,v="/api/admin/data_migration/export/route";function R(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}},46307:(t,e,r)=>{function a(t){let e=t.cookies.get("auth");if(!e)return null;try{let t=decodeURIComponent(e.value);return JSON.parse(t)}catch(t){return null}}r.d(e,{l:()=>a})},35418:(t,e,r)=>{r.d(e,{D:()=>o});var a=r(2178),n=r.n(a);class o{static encrypt(t,e){try{return n().AES.encrypt(t,e).toString()}catch(t){throw Error("加密失败")}}static decrypt(t,e){try{let r=n().AES.decrypt(t,e).toString(n().enc.Utf8);if(!r)throw Error("解密失败，请检查密码是否正确");return r}catch(t){throw Error("解密失败，请检查密码是否正确")}}static canDecrypt(t,e){try{return this.decrypt(t,e).length>0}catch{return!1}}}},31305:(t,e,r)=>{r.d(e,{w:()=>a});let a="2.7.1"}};var e=require("../../../../../webpack-runtime.js");e.C(t);var r=t=>e(e.s=t),a=e.X(0,[677,9864,3001,2178,7690],()=>r(96765));module.exports=a})();