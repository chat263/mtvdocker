"use strict";(()=>{var e={};e.id=6901,e.ids=[6901],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},98216:e=>{e.exports=require("net")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6005:e=>{e.exports=require("node:crypto")},33371:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>C,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>d});var a={};r.r(a),r.d(a,{GET:()=>p,runtime:()=>l});var o=r(4762),s=r(20515),i=r(4894),n=r(40379),c=r(13303),u=r(48126);let l="nodejs";async function p(e){let{searchParams:t}=new URL(e.url),r=t.get("type"),a=t.get("tag"),o=parseInt(t.get("pageSize")||"16"),s=parseInt(t.get("pageStart")||"0");if(!r||!a)return n.NextResponse.json({error:"缺少必要参数: type 或 tag"},{status:400});if(!["tv","movie"].includes(r))return n.NextResponse.json({error:"type 参数必须是 tv 或 movie"},{status:400});if(o<1||o>100)return n.NextResponse.json({error:"pageSize 必须在 1-100 之间"},{status:400});if(s<0)return n.NextResponse.json({error:"pageStart 不能小于 0"},{status:400});if("top250"===a)return function(e){let t=`https://movie.douban.com/top250?start=${e}&filter=`,r=new AbortController,a=setTimeout(()=>r.abort(),1e4);return fetch(t,{signal:r.signal,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36",Referer:"https://movie.douban.com/",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"}}).then(async e=>{let t;if(clearTimeout(a),!e.ok)throw Error(`HTTP error! Status: ${e.status}`);let r=await e.text(),o=/<div class="item">[\s\S]*?<a[^>]+href="https?:\/\/movie\.douban\.com\/subject\/(\d+)\/"[\s\S]*?<img[^>]+alt="([^"]+)"[^>]*src="([^"]+)"[\s\S]*?<span class="rating_num"[^>]*>([^<]*)<\/span>[\s\S]*?<\/div>/g,s=[];for(;null!==(t=o.exec(r));){let e=t[1],r=t[2],a=t[3],o=t[4]||"",i=a.replace(/^http:/,"https:");s.push({id:e,title:r,poster:i,rate:o,year:""})}let i=await (0,c.jT)();return n.NextResponse.json({code:200,message:"获取成功",list:s},{headers:{"Cache-Control":`public, max-age=${i}, s-maxage=${i}`,"CDN-Cache-Control":`public, s-maxage=${i}`,"Vercel-CDN-Cache-Control":`public, s-maxage=${i}`,"Netlify-Vary":"query"}})}).catch(e=>(clearTimeout(a),n.NextResponse.json({error:"获取豆瓣 Top250 数据失败",details:e.message},{status:500})))}(s);let i=`https://movie.douban.com/j/search_subjects?type=${r}&tag=${a}&sort=recommend&page_limit=${o}&page_start=${s}`;try{let e=(await (0,u.C)(i)).subjects.map(e=>({id:e.id,title:e.title,poster:e.cover,rate:e.rate,year:""})),t=await (0,c.jT)();return n.NextResponse.json({code:200,message:"获取成功",list:e},{headers:{"Cache-Control":`public, max-age=${t}, s-maxage=${t}`,"CDN-Cache-Control":`public, s-maxage=${t}`,"Vercel-CDN-Cache-Control":`public, s-maxage=${t}`,"Netlify-Vary":"query"}})}catch(e){return n.NextResponse.json({error:"获取豆瓣数据失败",details:e.message},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/douban/route",pathname:"/api/douban",filename:"route",bundlePath:"app/api/douban/route"},resolvedPagePath:"/app/src/app/api/douban/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:d,serverHooks:f}=m,C="/api/douban/route";function y(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:d})}},13303:(e,t,r)=>{let a;r.d(t,{Hz:()=>s,Ih:()=>l,iE:()=>c,jT:()=>p,ll:()=>m,mL:()=>i,xg:()=>u,yT:()=>g});var o=r(97690);let s={search:{path:"?ac=videolist&wd=",pagePath:"?ac=videolist&wd={query}&pg={page}",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json"}},detail:{path:"?ac=videolist&ids=",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json"}}};function i(e){let t;try{t=JSON.parse(e.ConfigFile)}catch(e){t={}}let r=Object.entries(t.api_site||[]),a=new Map((e.SourceConfig||[]).map(e=>[e.key,e]));r.forEach(([e,t])=>{let r=a.get(e);r?(r.name=t.name,r.api=t.api,r.detail=t.detail,r.from="config"):a.set(e,{key:e,name:t.name,api:t.api,detail:t.detail,from:"config",disabled:!1})});let o=new Set(r.map(([e])=>e));a.forEach(e=>{o.has(e.key)||(e.from="custom")}),e.SourceConfig=Array.from(a.values());let s=t.custom_category||[],i=new Map((e.CustomCategories||[]).map(e=>[e.query+e.type,e]));s.forEach(e=>{let t=e.query+e.type,r=i.get(t);r?(r.name=e.name,r.query=e.query,r.type=e.type,r.from="config"):i.set(t,{name:e.name,type:e.type,query:e.query,from:"config",disabled:!1})});let n=new Set(s.map(e=>e.query+e.type));return i.forEach(e=>{n.has(e.query+e.type)||(e.from="custom")}),e.CustomCategories=Array.from(i.values()),e}async function n(e,t={URL:"",AutoUpdate:!1,LastCheck:""}){let r;try{r=JSON.parse(e)}catch(e){r={}}let a={ConfigFile:e,ConfigSubscribtion:t,SiteConfig:{SiteName:process.env.NEXT_PUBLIC_SITE_NAME||"MoonTV",Announcement:process.env.ANNOUNCEMENT||"本网站仅提供影视信息搜索服务，所有内容均来自第三方网站。本站不存储任何视频资源，不对任何内容的准确性、合法性、完整性负责。",SearchDownstreamMaxPage:Number(process.env.NEXT_PUBLIC_SEARCH_MAX_PAGE)||5,SiteInterfaceCacheTime:r.cache_time||7200,DoubanProxyType:process.env.NEXT_PUBLIC_DOUBAN_PROXY_TYPE||"melody-cdn-sharon",DoubanProxy:process.env.NEXT_PUBLIC_DOUBAN_PROXY||"",DoubanImageProxyType:process.env.NEXT_PUBLIC_DOUBAN_IMAGE_PROXY_TYPE||"melody-cdn-sharon",DoubanImageProxy:process.env.NEXT_PUBLIC_DOUBAN_IMAGE_PROXY||"",DisableYellowFilter:"true"===process.env.NEXT_PUBLIC_DISABLE_YELLOW_FILTER,FluidSearch:"false"!==process.env.NEXT_PUBLIC_FLUID_SEARCH},UserConfig:{AllowRegister:"true"===process.env.NEXT_PUBLIC_ENABLE_REGISTER,Users:[]},SourceConfig:[],CustomCategories:[]},s=[];try{s=await o.db.getAllUsers()}catch(e){console.error("获取用户列表失败:",e)}let i=s.filter(e=>e!==process.env.USERNAME).map(e=>({username:e,role:"user",banned:!1}));return i.unshift({username:process.env.USERNAME,role:"owner",banned:!1}),a.UserConfig.Users=i,Object.entries(r.api_site||[]).forEach(([e,t])=>{a.SourceConfig.push({key:e,name:t.name,api:t.api,detail:t.detail,from:"config",disabled:!1})}),r.custom_category?.forEach(e=>{a.CustomCategories.push({name:e.name||e.query,type:e.type,query:e.query,from:"config",disabled:!1})}),a}async function c(){if(a)return a;let e=null;try{e=await o.db.getAdminConfig()}catch(e){console.error("获取管理员配置失败:",e)}return e||(e=await n("")),a=e=u(e),o.db.saveAdminConfig(a),a}function u(e){e.UserConfig||(e.UserConfig={AllowRegister:!1,Users:[]}),e.UserConfig.Users&&Array.isArray(e.UserConfig.Users)||(e.UserConfig.Users=[]),e.SourceConfig&&Array.isArray(e.SourceConfig)||(e.SourceConfig=[]),e.CustomCategories&&Array.isArray(e.CustomCategories)||(e.CustomCategories=[]);let t=process.env.USERNAME,r=new Set;e.UserConfig.Users=e.UserConfig.Users.filter(e=>!r.has(e.username)&&(r.add(e.username),!0)),e.UserConfig.Users=e.UserConfig.Users.filter(e=>e.username!==t),e.UserConfig.Users.forEach(e=>{"owner"===e.role&&(e.role="user")}),e.UserConfig.Users.unshift({username:t,role:"owner",banned:!1});let a=new Set;e.SourceConfig=e.SourceConfig.filter(e=>!a.has(e.key)&&(a.add(e.key),!0));let o=new Set;return e.CustomCategories=e.CustomCategories.filter(e=>!o.has(e.query+e.type)&&(o.add(e.query+e.type),!0)),e}async function l(){let e=null;try{e=await o.db.getAdminConfig()}catch(e){console.error("获取管理员配置失败:",e)}e||(e={});let t=await n(e.ConfigFile,e.ConfigSubscribtion);a=t,await o.db.saveAdminConfig(t)}async function p(){return(await c()).SiteConfig.SiteInterfaceCacheTime||7200}async function m(){return(await c()).SourceConfig.filter(e=>!e.disabled).map(e=>({key:e.key,name:e.name,api:e.api,detail:e.detail}))}async function g(e){a=e}},48126:(e,t,r)=>{r.d(t,{C:()=>a});async function a(e){let t=new AbortController,r=setTimeout(()=>t.abort(),1e4),a={signal:t.signal,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36",Referer:"https://movie.douban.com/",Accept:"application/json, text/plain, */*",Origin:"https://movie.douban.com"}};try{let t=await fetch(e,a);if(clearTimeout(r),!t.ok)throw Error(`HTTP error! Status: ${t.status}`);return await t.json()}catch(e){throw clearTimeout(r),e}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[677,9864,3001,7690],()=>r(33371));module.exports=a})();