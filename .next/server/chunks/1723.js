"use strict";exports.id=1723,exports.ids=[1723],exports.modules={73469:(e,t,a)=>{a.d(t,{C2:()=>U,Ev:()=>w,F0:()=>m,Ji:()=>y,Lj:()=>S,Rr:()=>p,Rw:()=>g,c1:()=>u,j5:()=>E,jz:()=>v,qn:()=>f,r7:()=>C});var r=a(7899);let o="1.0.0",i=process.env.STORAGE_TYPE||"localstorage";class n{static getInstance(){return n.instance||(n.instance=new n),n.instance}getCurrentUsername(){let e=(0,r.v)();return e?.username||null}getUserCacheKey(e){return`moontv_cache_${e}`}getUserCache(e){return{}}saveUserCache(e,t){}cleanOldCache(e){let t=Date.now();e.playRecords&&t-e.playRecords.timestamp>5184e6&&delete e.playRecords,e.favorites&&t-e.favorites.timestamp>5184e6&&delete e.favorites}clearAllCache(){Object.keys(localStorage).forEach(e=>{e.startsWith("moontv_cache_")&&localStorage.removeItem(e)})}isCacheValid(e){let t=Date.now();return e.version===o&&t-e.timestamp<36e5}createCacheData(e){return{data:e,timestamp:Date.now(),version:o}}getCachedPlayRecords(){let e=this.getCurrentUsername();if(!e)return null;let t=this.getUserCache(e).playRecords;return t&&this.isCacheValid(t)?t.data:null}cachePlayRecords(e){let t=this.getCurrentUsername();if(!t)return;let a=this.getUserCache(t);a.playRecords=this.createCacheData(e),this.saveUserCache(t,a)}getCachedFavorites(){let e=this.getCurrentUsername();if(!e)return null;let t=this.getUserCache(e).favorites;return t&&this.isCacheValid(t)?t.data:null}cacheFavorites(e){let t=this.getCurrentUsername();if(!t)return;let a=this.getUserCache(t);a.favorites=this.createCacheData(e),this.saveUserCache(t,a)}getCachedSearchHistory(){let e=this.getCurrentUsername();if(!e)return null;let t=this.getUserCache(e).searchHistory;return t&&this.isCacheValid(t)?t.data:null}cacheSearchHistory(e){let t=this.getCurrentUsername();if(!t)return;let a=this.getUserCache(t);a.searchHistory=this.createCacheData(e),this.saveUserCache(t,a)}getCachedSkipConfigs(){let e=this.getCurrentUsername();if(!e)return null;let t=this.getUserCache(e).skipConfigs;return t&&this.isCacheValid(t)?t.data:null}cacheSkipConfigs(e){let t=this.getCurrentUsername();if(!t)return;let a=this.getUserCache(t);a.skipConfigs=this.createCacheData(e),this.saveUserCache(t,a)}clearUserCache(e){let t=e||this.getCurrentUsername();if(t)try{let e=this.getUserCacheKey(t);localStorage.removeItem(e)}catch(e){console.warn("清除用户缓存失败:",e)}}clearExpiredCaches(){}}let s=n.getInstance();async function c(e,t){console.error(`数据库操作失败 (${e}):`,t);try{let t,a;switch(e){case"playRecords":t=await d("/api/playrecords"),s.cachePlayRecords(t),a="playRecordsUpdated";break;case"favorites":t=await d("/api/favorites"),s.cacheFavorites(t),a="favoritesUpdated";break;case"searchHistory":t=await d("/api/searchhistory"),s.cacheSearchHistory(t),a="searchHistoryUpdated"}window.dispatchEvent(new CustomEvent(a,{detail:t}))}catch(t){console.error(`刷新${e}缓存失败:`,t)}}async function l(e,t){let a=await fetch(e,t);if(!a.ok){if(401===a.status){try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"}})}catch(e){console.error("注销请求失败:",e)}let e=window.location.pathname+window.location.search,t=new URL("/login",window.location.origin);throw t.searchParams.set("redirect",e),window.location.href=t.toString(),Error("用户未授权，已跳转到登录页面")}throw Error(`请求 ${e} 失败: ${a.status}`)}return a}async function d(e){let t=await l(e);return await t.json()}function h(e,t){return`${e}+${t}`}async function p(){return{}}async function u(e,t,a){let r=h(e,t);if("localstorage"!==i){let e=s.getCachedPlayRecords()||{};e[r]=a,s.cachePlayRecords(e),window.dispatchEvent(new CustomEvent("playRecordsUpdated",{detail:e}));try{await l("/api/playrecords",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:r,record:a})})}catch(e){throw await c("playRecords",e),e}return}console.warn("无法在服务端保存播放记录到 localStorage")}async function y(e,t){let a=h(e,t);if("localstorage"!==i){let e=s.getCachedPlayRecords()||{};delete e[a],s.cachePlayRecords(e),window.dispatchEvent(new CustomEvent("playRecordsUpdated",{detail:e}));try{await l(`/api/playrecords?key=${encodeURIComponent(a)}`,{method:"DELETE"})}catch(e){throw await c("playRecords",e),e}return}console.warn("无法在服务端删除播放记录到 localStorage")}async function m(e){let t=e.trim();if(t&&"localstorage"!==i){let e=[t,...(s.getCachedSearchHistory()||[]).filter(e=>e!==t)];e.length>20&&(e.length=20),s.cacheSearchHistory(e),window.dispatchEvent(new CustomEvent("searchHistoryUpdated",{detail:e}));try{await l("/api/searchhistory",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({keyword:t})})}catch(e){await c("searchHistory",e)}return}}async function w(){if("localstorage"!==i){s.cacheSearchHistory([]),window.dispatchEvent(new CustomEvent("searchHistoryUpdated",{detail:[]}));try{await l("/api/searchhistory",{method:"DELETE"})}catch(e){await c("searchHistory",e)}return}}async function g(e){let t=e.trim();if(t&&"localstorage"!==i){let e=(s.getCachedSearchHistory()||[]).filter(e=>e!==t);s.cacheSearchHistory(e),window.dispatchEvent(new CustomEvent("searchHistoryUpdated",{detail:e}));try{await l(`/api/searchhistory?keyword=${encodeURIComponent(t)}`,{method:"DELETE"})}catch(e){await c("searchHistory",e)}return}}async function f(e,t,a){let r=h(e,t);if("localstorage"!==i){let e=s.getCachedFavorites()||{};e[r]=a,s.cacheFavorites(e),window.dispatchEvent(new CustomEvent("favoritesUpdated",{detail:e}));try{await l("/api/favorites",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:r,favorite:a})})}catch(e){throw await c("favorites",e),e}return}console.warn("无法在服务端保存收藏到 localStorage")}async function C(e,t){let a=h(e,t);if("localstorage"!==i){let e=s.getCachedFavorites()||{};delete e[a],s.cacheFavorites(e),window.dispatchEvent(new CustomEvent("favoritesUpdated",{detail:e}));try{await l(`/api/favorites?key=${encodeURIComponent(a)}`,{method:"DELETE"})}catch(e){throw await c("favorites",e),e}return}console.warn("无法在服务端删除收藏到 localStorage")}async function v(){if("localstorage"!==i){s.cachePlayRecords({}),window.dispatchEvent(new CustomEvent("playRecordsUpdated",{detail:{}}));try{await l("/api/playrecords",{method:"DELETE",headers:{"Content-Type":"application/json"}})}catch(e){throw await c("playRecords",e),e}return}}async function E(){if("localstorage"!==i){s.cacheFavorites({}),window.dispatchEvent(new CustomEvent("favoritesUpdated",{detail:{}}));try{await l("/api/favorites",{method:"DELETE",headers:{"Content-Type":"application/json"}})}catch(e){throw await c("favorites",e),e}return}}async function U(e,t,a){let r=h(e,t);if("localstorage"!==i){let e=s.getCachedSkipConfigs()||{};e[r]=a,s.cacheSkipConfigs(e),window.dispatchEvent(new CustomEvent("skipConfigsUpdated",{detail:e}));try{await l("/api/skipconfigs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:r,config:a})})}catch(e){console.error("保存跳过片头片尾配置失败:",e)}return}console.warn("无法在服务端保存跳过片头片尾配置到 localStorage")}async function S(e,t){let a=h(e,t);if("localstorage"!==i){let e=s.getCachedSkipConfigs()||{};delete e[a],s.cacheSkipConfigs(e),window.dispatchEvent(new CustomEvent("skipConfigsUpdated",{detail:e}));try{await l(`/api/skipconfigs?key=${encodeURIComponent(a)}`,{method:"DELETE"})}catch(e){console.error("删除跳过片头片尾配置失败:",e)}return}console.warn("无法在服务端删除跳过片头片尾配置到 localStorage")}},94434:(e,t,a)=>{a.d(t,{a8:()=>o,e9:()=>i}),a(79029);var r=a(37531);function o(e){if(!e||!e.includes("doubanio.com"))return e;let{proxyType:t,proxyUrl:a}={proxyType:localStorage.getItem("doubanImageProxyType")||window.RUNTIME_CONFIG?.DOUBAN_IMAGE_PROXY_TYPE||"direct",proxyUrl:localStorage.getItem("doubanImageProxyUrl")||window.RUNTIME_CONFIG?.DOUBAN_IMAGE_PROXY||""};switch(t){case"server":return`/api/image-proxy?url=${encodeURIComponent(e)}`;case"img3":return e.replace(/img\d+\.doubanio\.com/g,"img3.doubanio.com");case"cmliussss-cdn-tencent":return e.replace(/img\d+\.doubanio\.com/g,"img.doubanio.cmliussss.net");case"cmliussss-cdn-ali":return e.replace(/img\d+\.doubanio\.com/g,"img.doubanio.cmliussss.com");case"custom":return`${a}${encodeURIComponent(e)}`;default:return e}}async function i(e){try{return new Promise((t,a)=>{let o=document.createElement("video");o.muted=!0,o.preload="metadata";let i=performance.now(),n=0;fetch(e,{method:"HEAD",mode:"no-cors"}).then(()=>{n=performance.now()-i}).catch(()=>{n=performance.now()-i});let s=new r.ZP,c=setTimeout(()=>{s.destroy(),o.remove(),a(Error("Timeout loading video metadata"))},4e3);o.onerror=()=>{clearTimeout(c),s.destroy(),o.remove(),a(Error("Failed to load video metadata"))};let l="未知",d=!1,h=!1,p=0,u=()=>{if(h&&(d||"未知"!==l)){clearTimeout(c);let e=o.videoWidth;e&&e>0?(s.destroy(),o.remove(),t({quality:e>=3840?"4K":e>=2560?"2K":e>=1920?"1080p":e>=1280?"720p":e>=854?"480p":"SD",loadSpeed:l,pingTime:Math.round(n)})):t({quality:"未知",loadSpeed:l,pingTime:Math.round(n)})}};s.on(r.ZP.Events.FRAG_LOADING,()=>{p=performance.now()}),s.on(r.ZP.Events.FRAG_LOADED,(e,t)=>{if(p>0&&t&&t.payload&&!d){let e=performance.now()-p,a=t.payload.byteLength||0;if(e>0&&a>0){let t=a/1024/(e/1e3);l=t>=1024?`${(t/1024).toFixed(1)} MB/s`:`${t.toFixed(1)} KB/s`,d=!0,u()}}}),s.loadSource(e),s.attachMedia(o),s.on(r.ZP.Events.ERROR,(e,t)=>{console.error("HLS错误:",t),t.fatal&&(clearTimeout(c),s.destroy(),o.remove(),a(Error(`HLS播放失败: ${t.type}`)))}),o.onloadedmetadata=()=>{h=!0,u()}})}catch(e){throw Error(`Error getting video resolution: ${e instanceof Error?e.message:String(e)}`)}}}};