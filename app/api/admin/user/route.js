"use strict";(()=>{var e={};e.id=272,e.ids=[272],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},98216:e=>{e.exports=require("net")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6005:e=>{e.exports=require("node:crypto")},7333:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>C,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>y,staticGenerationAsyncStorage:()=>N});var s={};t.r(s),t.d(s,{POST:()=>d,runtime:()=>l});var n=t(4762),o=t(20515),a=t(4894),i=t(40379),u=t(46307),p=t(13303),c=t(35737);let l="nodejs",f=["add","ban","unban","setAdmin","cancelAdmin","setAllowRegister","changePassword","deleteUser"];async function d(e){if("localstorage"===(process.env.NEXT_PUBLIC_STORAGE_TYPE||"localstorage"))return i.NextResponse.json({error:"不支持本地存储进行管理员配置"},{status:400});try{let r;let t=await e.json(),s=(0,u.l)(e);if(!s||!s.username)return i.NextResponse.json({error:"Unauthorized"},{status:401});let n=s.username,{targetUsername:o,targetPassword:a,allowRegister:l,action:d}=t;if(!d||!f.includes(d))return i.NextResponse.json({error:"参数格式错误"},{status:400});if("setAllowRegister"!==d&&!o)return i.NextResponse.json({error:"缺少目标用户名"},{status:400});if("setAllowRegister"!==d&&"changePassword"!==d&&"deleteUser"!==d&&n===o)return i.NextResponse.json({error:"无法对自己进行此操作"},{status:400});let m=await (0,p.iE)(),g=(0,c.cF)();if(n===process.env.USERNAME)r="owner";else{let e=m.UserConfig.Users.find(e=>e.username===n);if(!e||"admin"!==e.role||e.banned)return i.NextResponse.json({error:"权限不足"},{status:401});r="admin"}let N=m.UserConfig.Users.find(e=>e.username===o);if(N&&"owner"===N.role&&"changePassword"!==d)return i.NextResponse.json({error:"无法操作站长"},{status:400});let y=N?.role==="admin";if("setAllowRegister"===d){if("boolean"!=typeof l)return i.NextResponse.json({error:"参数格式错误"},{status:400});m.UserConfig.AllowRegister=l}else switch(d){case"add":if(N)return i.NextResponse.json({error:"用户已存在"},{status:400});if(!a)return i.NextResponse.json({error:"缺少目标用户密码"},{status:400});if(!g||"function"!=typeof g.registerUser)return i.NextResponse.json({error:"存储未配置用户注册"},{status:500});await g.registerUser(o,a),m.UserConfig.Users.push({username:o,role:"user"}),N=m.UserConfig.Users[m.UserConfig.Users.length-1];break;case"ban":if(!N)return i.NextResponse.json({error:"目标用户不存在"},{status:404});if(y&&"owner"!==r)return i.NextResponse.json({error:"仅站长可封禁管理员"},{status:401});N.banned=!0;break;case"unban":if(!N)return i.NextResponse.json({error:"目标用户不存在"},{status:404});if(y&&"owner"!==r)return i.NextResponse.json({error:"仅站长可操作管理员"},{status:401});N.banned=!1;break;case"setAdmin":if(!N)return i.NextResponse.json({error:"目标用户不存在"},{status:404});if("admin"===N.role)return i.NextResponse.json({error:"该用户已是管理员"},{status:400});if("owner"!==r)return i.NextResponse.json({error:"仅站长可设置管理员"},{status:401});N.role="admin";break;case"cancelAdmin":if(!N)return i.NextResponse.json({error:"目标用户不存在"},{status:404});if("admin"!==N.role)return i.NextResponse.json({error:"目标用户不是管理员"},{status:400});if("owner"!==r)return i.NextResponse.json({error:"仅站长可取消管理员"},{status:401});N.role="user";break;case"changePassword":if(!N)return i.NextResponse.json({error:"目标用户不存在"},{status:404});if(!a)return i.NextResponse.json({error:"缺少新密码"},{status:400});if("owner"===N.role)return i.NextResponse.json({error:"无法修改站长密码"},{status:401});if(y&&"owner"!==r&&n!==o)return i.NextResponse.json({error:"仅站长可修改其他管理员密码"},{status:401});if(!g||"function"!=typeof g.changePassword)return i.NextResponse.json({error:"存储未配置密码修改功能"},{status:500});await g.changePassword(o,a);break;case"deleteUser":{if(!N)return i.NextResponse.json({error:"目标用户不存在"},{status:404});if(n===o)return i.NextResponse.json({error:"不能删除自己"},{status:400});if(y&&"owner"!==r)return i.NextResponse.json({error:"仅站长可删除管理员"},{status:401});if(!g||"function"!=typeof g.deleteUser)return i.NextResponse.json({error:"存储未配置用户删除功能"},{status:500});await g.deleteUser(o);let e=m.UserConfig.Users.findIndex(e=>e.username===o);e>-1&&m.UserConfig.Users.splice(e,1);break}default:return i.NextResponse.json({error:"未知操作"},{status:400})}return g&&"function"==typeof g.setAdminConfig&&await g.setAdminConfig(m),i.NextResponse.json({ok:!0},{headers:{"Cache-Control":"no-store"}})}catch(e){return console.error("用户管理操作失败:",e),i.NextResponse.json({error:"用户管理操作失败",details:e.message},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/user/route",pathname:"/api/admin/user",filename:"route",bundlePath:"app/api/admin/user/route"},resolvedPagePath:"/app/src/app/api/admin/user/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:N,serverHooks:y}=m,C="/api/admin/user/route";function x(){return(0,a.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:N})}},46307:(e,r,t)=>{function s(e){let r=e.cookies.get("auth");if(!r)return null;try{let e=decodeURIComponent(r.value);return JSON.parse(e)}catch(e){return null}}t.d(r,{l:()=>s})},13303:(e,r,t)=>{let s;t.d(r,{Hz:()=>o,Ih:()=>p,iE:()=>u,jT:()=>c,ll:()=>l,mL:()=>a});var n=t(35737);let o={search:{path:"?ac=videolist&wd=",pagePath:"?ac=videolist&wd={query}&pg={page}",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json"}},detail:{path:"?ac=videolist&ids=",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json"}}};function a(e){let r;try{r=JSON.parse(e.ConfigFile)}catch(e){r={}}let t=Object.entries(r.api_site||[]),s=new Map((e.SourceConfig||[]).map(e=>[e.key,e]));t.forEach(([e,r])=>{let t=s.get(e);t?(t.name=r.name,t.api=r.api,t.detail=r.detail,t.from="config"):s.set(e,{key:e,name:r.name,api:r.api,detail:r.detail,from:"config",disabled:!1})});let n=new Set(t.map(([e])=>e));s.forEach(e=>{n.has(e.key)||(e.from="custom")}),e.SourceConfig=Array.from(s.values());let o=r.custom_category||[],a=new Map((e.CustomCategories||[]).map(e=>[e.query+e.type,e]));o.forEach(e=>{let r=e.query+e.type,t=a.get(r);t?(t.name=e.name,t.query=e.query,t.type=e.type,t.from="config"):a.set(r,{name:e.name,type:e.type,query:e.query,from:"config",disabled:!1})});let i=new Set(o.map(e=>e.query+e.type));return a.forEach(e=>{i.has(e.query+e.type)||(e.from="custom")}),e.CustomCategories=Array.from(a.values()),e}async function i(e,r={URL:"",AutoUpdate:!1,LastCheck:""}){let t;try{t=JSON.parse(e)}catch(e){t={}}let s={ConfigFile:e,ConfigSubscribtion:r,SiteConfig:{SiteName:process.env.NEXT_PUBLIC_SITE_NAME||"MoonTV",Announcement:process.env.ANNOUNCEMENT||"本网站仅提供影视信息搜索服务，所有内容均来自第三方网站。本站不存储任何视频资源，不对任何内容的准确性、合法性、完整性负责。",SearchDownstreamMaxPage:Number(process.env.NEXT_PUBLIC_SEARCH_MAX_PAGE)||5,SiteInterfaceCacheTime:t.cache_time||7200,DoubanProxyType:process.env.NEXT_PUBLIC_DOUBAN_PROXY_TYPE||"direct",DoubanProxy:process.env.NEXT_PUBLIC_DOUBAN_PROXY||"",DoubanImageProxyType:process.env.NEXT_PUBLIC_DOUBAN_IMAGE_PROXY_TYPE||"direct",DoubanImageProxy:process.env.NEXT_PUBLIC_DOUBAN_IMAGE_PROXY||"",DisableYellowFilter:"true"===process.env.NEXT_PUBLIC_DISABLE_YELLOW_FILTER},UserConfig:{AllowRegister:"true"===process.env.NEXT_PUBLIC_ENABLE_REGISTER,Users:[]},SourceConfig:[],CustomCategories:[]},o=(0,n.cF)(),a=[];if(o&&"function"==typeof o.getAllUsers)try{a=await o.getAllUsers()}catch(e){console.error("获取用户列表失败:",e)}let i=a.filter(e=>e!==process.env.USERNAME).map(e=>({username:e,role:"user",banned:!1}));return i.unshift({username:process.env.USERNAME,role:"owner",banned:!1}),s.UserConfig.Users=i,Object.entries(t.api_site||[]).forEach(([e,r])=>{s.SourceConfig.push({key:e,name:r.name,api:r.api,detail:r.detail,from:"config",disabled:!1})}),t.custom_category?.forEach(e=>{s.CustomCategories.push({name:e.name||e.query,type:e.type,query:e.query,from:"config",disabled:!1})}),s}async function u(){if(s)return s;let e=(0,n.cF)(),r=null;return e&&"function"==typeof e.getAdminConfig&&(r=await e.getAdminConfig()),r||(r=await i("")),s=r}async function p(){let e;let r=(0,n.cF)();e=r&&"function"==typeof r.getAdminConfig?await r.getAdminConfig():{};let t=await i(e.ConfigFile,e.ConfigSubscribtion);s=t,r&&"function"==typeof r.setAdminConfig&&await r.setAdminConfig(t)}async function c(){return(await u()).SiteConfig.SiteInterfaceCacheTime||7200}async function l(){return(await u()).SourceConfig.filter(e=>!e.disabled).map(e=>({key:e.key,name:e.name,api:e.api,detail:e.detail}))}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[7796,9864,3001,5737],()=>t(7333));module.exports=s})();