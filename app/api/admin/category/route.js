"use strict";(()=>{var e={};e.id=6980,e.ids=[6980],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},98216:e=>{e.exports=require("net")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6005:e=>{e.exports=require("node:crypto")},7600:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>y,patchFetch:()=>h,requestAsyncStorage:()=>m,routeModule:()=>f,serverHooks:()=>C,staticGenerationAsyncStorage:()=>g});var s={};t.r(s),t.d(s,{POST:()=>d,runtime:()=>p});var o=t(4762),a=t(20515),n=t(4894),i=t(40379),u=t(46307),l=t(13303),c=t(97690);let p="nodejs";async function d(e){if("localstorage"===(process.env.NEXT_PUBLIC_STORAGE_TYPE||"localstorage"))return i.NextResponse.json({error:"不支持本地存储进行管理员配置"},{status:400});try{let r=await e.json(),{action:t}=r,s=(0,u.l)(e);if(!s||!s.username)return i.NextResponse.json({error:"Unauthorized"},{status:401});let o=s.username;if(!o||!t||!["add","disable","enable","delete","sort"].includes(t))return i.NextResponse.json({error:"参数格式错误"},{status:400});let a=await (0,l.iE)();if(o!==process.env.USERNAME){let e=a.UserConfig.Users.find(e=>e.username===o);if(!e||"admin"!==e.role||e.banned)return i.NextResponse.json({error:"权限不足"},{status:401})}switch(t){case"add":{let{name:e,type:t,query:s}=r;if(!e||!t||!s)return i.NextResponse.json({error:"缺少必要参数"},{status:400});if(a.CustomCategories.some(e=>e.query===s&&e.type===t))return i.NextResponse.json({error:"该分类已存在"},{status:400});a.CustomCategories.push({name:e,type:t,query:s,from:"custom",disabled:!1});break}case"disable":{let{query:e,type:t}=r;if(!e||!t)return i.NextResponse.json({error:"缺少 query 或 type 参数"},{status:400});let s=a.CustomCategories.find(r=>r.query===e&&r.type===t);if(!s)return i.NextResponse.json({error:"分类不存在"},{status:404});s.disabled=!0;break}case"enable":{let{query:e,type:t}=r;if(!e||!t)return i.NextResponse.json({error:"缺少 query 或 type 参数"},{status:400});let s=a.CustomCategories.find(r=>r.query===e&&r.type===t);if(!s)return i.NextResponse.json({error:"分类不存在"},{status:404});s.disabled=!1;break}case"delete":{let{query:e,type:t}=r;if(!e||!t)return i.NextResponse.json({error:"缺少 query 或 type 参数"},{status:400});let s=a.CustomCategories.findIndex(r=>r.query===e&&r.type===t);if(-1===s)return i.NextResponse.json({error:"分类不存在"},{status:404});let o=a.CustomCategories[s];if("config"===o.from)return i.NextResponse.json({error:"该分类不可删除"},{status:400});a.CustomCategories.splice(s,1);break}case"sort":{let{order:e}=r;if(!Array.isArray(e))return i.NextResponse.json({error:"排序列表格式错误"},{status:400});let t=new Map(a.CustomCategories.map(e=>[`${e.query}:${e.type}`,e])),s=[];e.forEach(e=>{let r=t.get(e);r&&(s.push(r),t.delete(e))}),a.CustomCategories.forEach(e=>{t.has(`${e.query}:${e.type}`)&&s.push(e)}),a.CustomCategories=s;break}default:return i.NextResponse.json({error:"未知操作"},{status:400})}return await c.db.saveAdminConfig(a),i.NextResponse.json({ok:!0},{headers:{"Cache-Control":"no-store"}})}catch(e){return console.error("分类管理操作失败:",e),i.NextResponse.json({error:"分类管理操作失败",details:e.message},{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/category/route",pathname:"/api/admin/category",filename:"route",bundlePath:"app/api/admin/category/route"},resolvedPagePath:"/app/src/app/api/admin/category/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:C}=f,y="/api/admin/category/route";function h(){return(0,n.patchFetch)({serverHooks:C,staticGenerationAsyncStorage:g})}},46307:(e,r,t)=>{function s(e){let r=e.cookies.get("auth");if(!r)return null;try{let e=decodeURIComponent(r.value);return JSON.parse(e)}catch(e){return null}}t.d(r,{l:()=>s})},13303:(e,r,t)=>{let s;t.d(r,{Hz:()=>a,Ih:()=>c,iE:()=>u,jT:()=>p,ll:()=>d,mL:()=>n,xg:()=>l,yT:()=>f});var o=t(97690);let a={search:{path:"?ac=videolist&wd=",pagePath:"?ac=videolist&wd={query}&pg={page}",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json"}},detail:{path:"?ac=videolist&ids=",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json"}}};function n(e){let r;try{r=JSON.parse(e.ConfigFile)}catch(e){r={}}let t=Object.entries(r.api_site||[]),s=new Map((e.SourceConfig||[]).map(e=>[e.key,e]));t.forEach(([e,r])=>{let t=s.get(e);t?(t.name=r.name,t.api=r.api,t.detail=r.detail,t.from="config"):s.set(e,{key:e,name:r.name,api:r.api,detail:r.detail,from:"config",disabled:!1})});let o=new Set(t.map(([e])=>e));s.forEach(e=>{o.has(e.key)||(e.from="custom")}),e.SourceConfig=Array.from(s.values());let a=r.custom_category||[],n=new Map((e.CustomCategories||[]).map(e=>[e.query+e.type,e]));a.forEach(e=>{let r=e.query+e.type,t=n.get(r);t?(t.name=e.name,t.query=e.query,t.type=e.type,t.from="config"):n.set(r,{name:e.name,type:e.type,query:e.query,from:"config",disabled:!1})});let i=new Set(a.map(e=>e.query+e.type));return n.forEach(e=>{i.has(e.query+e.type)||(e.from="custom")}),e.CustomCategories=Array.from(n.values()),e}async function i(e,r={URL:"",AutoUpdate:!1,LastCheck:""}){let t;try{t=JSON.parse(e)}catch(e){t={}}let s={ConfigFile:e,ConfigSubscribtion:r,SiteConfig:{SiteName:process.env.NEXT_PUBLIC_SITE_NAME||"MoonTV",Announcement:process.env.ANNOUNCEMENT||"本网站仅提供影视信息搜索服务，所有内容均来自第三方网站。本站不存储任何视频资源，不对任何内容的准确性、合法性、完整性负责。",SearchDownstreamMaxPage:Number(process.env.NEXT_PUBLIC_SEARCH_MAX_PAGE)||5,SiteInterfaceCacheTime:t.cache_time||7200,DoubanProxyType:process.env.NEXT_PUBLIC_DOUBAN_PROXY_TYPE||"melody-cdn-sharon",DoubanProxy:process.env.NEXT_PUBLIC_DOUBAN_PROXY||"",DoubanImageProxyType:process.env.NEXT_PUBLIC_DOUBAN_IMAGE_PROXY_TYPE||"melody-cdn-sharon",DoubanImageProxy:process.env.NEXT_PUBLIC_DOUBAN_IMAGE_PROXY||"",DisableYellowFilter:"true"===process.env.NEXT_PUBLIC_DISABLE_YELLOW_FILTER,FluidSearch:"false"!==process.env.NEXT_PUBLIC_FLUID_SEARCH},UserConfig:{AllowRegister:"true"===process.env.NEXT_PUBLIC_ENABLE_REGISTER,Users:[]},SourceConfig:[],CustomCategories:[]},a=[];try{a=await o.db.getAllUsers()}catch(e){console.error("获取用户列表失败:",e)}let n=a.filter(e=>e!==process.env.USERNAME).map(e=>({username:e,role:"user",banned:!1}));return n.unshift({username:process.env.USERNAME,role:"owner",banned:!1}),s.UserConfig.Users=n,Object.entries(t.api_site||[]).forEach(([e,r])=>{s.SourceConfig.push({key:e,name:r.name,api:r.api,detail:r.detail,from:"config",disabled:!1})}),t.custom_category?.forEach(e=>{s.CustomCategories.push({name:e.name||e.query,type:e.type,query:e.query,from:"config",disabled:!1})}),s}async function u(){if(s)return s;let e=null;try{e=await o.db.getAdminConfig()}catch(e){console.error("获取管理员配置失败:",e)}return e||(e=await i("")),s=e=l(e),o.db.saveAdminConfig(s),s}function l(e){e.UserConfig||(e.UserConfig={AllowRegister:!1,Users:[]}),e.UserConfig.Users&&Array.isArray(e.UserConfig.Users)||(e.UserConfig.Users=[]),e.SourceConfig&&Array.isArray(e.SourceConfig)||(e.SourceConfig=[]),e.CustomCategories&&Array.isArray(e.CustomCategories)||(e.CustomCategories=[]);let r=process.env.USERNAME,t=new Set;e.UserConfig.Users=e.UserConfig.Users.filter(e=>!t.has(e.username)&&(t.add(e.username),!0)),e.UserConfig.Users=e.UserConfig.Users.filter(e=>e.username!==r),e.UserConfig.Users.forEach(e=>{"owner"===e.role&&(e.role="user")}),e.UserConfig.Users.unshift({username:r,role:"owner",banned:!1});let s=new Set;e.SourceConfig=e.SourceConfig.filter(e=>!s.has(e.key)&&(s.add(e.key),!0));let o=new Set;return e.CustomCategories=e.CustomCategories.filter(e=>!o.has(e.query+e.type)&&(o.add(e.query+e.type),!0)),e}async function c(){let e=null;try{e=await o.db.getAdminConfig()}catch(e){console.error("获取管理员配置失败:",e)}e||(e={});let r=await i(e.ConfigFile,e.ConfigSubscribtion);s=r,await o.db.saveAdminConfig(r)}async function p(){return(await u()).SiteConfig.SiteInterfaceCacheTime||7200}async function d(){return(await u()).SourceConfig.filter(e=>!e.disabled).map(e=>({key:e.key,name:e.name,api:e.api,detail:e.detail}))}async function f(e){s=e}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[677,9864,3001,7690],()=>t(7600));module.exports=s})();