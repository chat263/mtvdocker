"use strict";(()=>{var e={};e.id=4510,e.ids=[4510],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},98216:e=>{e.exports=require("net")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},8082:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>E,patchFetch:()=>A,requestAsyncStorage:()=>C,routeModule:()=>y,serverHooks:()=>U,staticGenerationAsyncStorage:()=>h});var a={};t.r(a),t.d(a,{POST:()=>g});var o=t(4762),s=t(20515),i=t(4894),n=t(40379),c=t(21764),u=t(71568),p=t(46307),l=t(13303),f=t(35418),d=t(97690);let m=(0,c.promisify)(u.gunzip);async function g(e){try{let r,t;let a=process.env.NEXT_PUBLIC_STORAGE_TYPE||"localstorage";if("localstorage"===a)return n.NextResponse.json({error:"不支持本地存储进行数据迁移"},{status:400});let o=(0,p.l)(e);if(!o||!o.username)return n.NextResponse.json({error:"未登录"},{status:401});if(o.username!==process.env.USERNAME)return n.NextResponse.json({error:"权限不足，只有站长可以导入数据"},{status:401});let s=await e.formData(),i=s.get("file"),c=s.get("password");if(!i)return n.NextResponse.json({error:"请选择备份文件"},{status:400});if(!c)return n.NextResponse.json({error:"请提供解密密码"},{status:400});let u=await i.text();try{r=f.D.decrypt(u,c)}catch(e){return n.NextResponse.json({error:"解密失败，请检查密码是否正确"},{status:400})}let g=Buffer.from(r,"base64"),y=(await m(g)).toString();try{t=JSON.parse(y)}catch(e){return n.NextResponse.json({error:"备份文件格式错误"},{status:400})}if(!t.data||!t.data.adminConfig||!t.data.userData)return n.NextResponse.json({error:"备份文件格式无效"},{status:400});await d.db.clearAllData(),t.data.adminConfig=(0,l.xg)(t.data.adminConfig),await d.db.saveAdminConfig(t.data.adminConfig),await (0,l.yT)(t.data.adminConfig);let C=t.data.userData;for(let e in C){let r=C[e];if(r.password&&await d.db.registerUser(e,r.password),r.playRecords)for(let[t,a]of Object.entries(r.playRecords))await d.db.storage.setPlayRecord(e,t,a);if(r.favorites)for(let[t,a]of Object.entries(r.favorites))await d.db.storage.setFavorite(e,t,a);if(r.searchHistory&&Array.isArray(r.searchHistory))for(let t of r.searchHistory.reverse())await d.db.addSearchHistory(e,t);if(r.skipConfigs)for(let[t,a]of Object.entries(r.skipConfigs)){let[r,o]=t.split("+");r&&o&&await d.db.setSkipConfig(e,r,o,a)}}return n.NextResponse.json({message:"数据导入成功",importedUsers:Object.keys(C).length,timestamp:t.timestamp,serverVersion:"string"==typeof t.serverVersion?t.serverVersion:"未知版本"})}catch(e){return console.error("数据导入失败:",e),n.NextResponse.json({error:e instanceof Error?e.message:"导入失败"},{status:500})}}let y=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/data_migration/import/route",pathname:"/api/admin/data_migration/import",filename:"route",bundlePath:"app/api/admin/data_migration/import/route"},resolvedPagePath:"/app/src/app/api/admin/data_migration/import/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:C,staticGenerationAsyncStorage:h,serverHooks:U}=y,E="/api/admin/data_migration/import/route";function A(){return(0,i.patchFetch)({serverHooks:U,staticGenerationAsyncStorage:h})}},46307:(e,r,t)=>{function a(e){let r=e.cookies.get("auth");if(!r)return null;try{let e=decodeURIComponent(r.value);return JSON.parse(e)}catch(e){return null}}t.d(r,{l:()=>a})},13303:(e,r,t)=>{let a;t.d(r,{Hz:()=>s,Ih:()=>p,iE:()=>c,jT:()=>l,ll:()=>f,mL:()=>i,xg:()=>u,yT:()=>d});var o=t(97690);let s={search:{path:"?ac=videolist&wd=",pagePath:"?ac=videolist&wd={query}&pg={page}",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json"}},detail:{path:"?ac=videolist&ids=",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json"}}};function i(e){let r;try{r=JSON.parse(e.ConfigFile)}catch(e){r={}}let t=Object.entries(r.api_site||[]),a=new Map((e.SourceConfig||[]).map(e=>[e.key,e]));t.forEach(([e,r])=>{let t=a.get(e);t?(t.name=r.name,t.api=r.api,t.detail=r.detail,t.from="config"):a.set(e,{key:e,name:r.name,api:r.api,detail:r.detail,from:"config",disabled:!1})});let o=new Set(t.map(([e])=>e));a.forEach(e=>{o.has(e.key)||(e.from="custom")}),e.SourceConfig=Array.from(a.values());let s=r.custom_category||[],i=new Map((e.CustomCategories||[]).map(e=>[e.query+e.type,e]));s.forEach(e=>{let r=e.query+e.type,t=i.get(r);t?(t.name=e.name,t.query=e.query,t.type=e.type,t.from="config"):i.set(r,{name:e.name,type:e.type,query:e.query,from:"config",disabled:!1})});let n=new Set(s.map(e=>e.query+e.type));return i.forEach(e=>{n.has(e.query+e.type)||(e.from="custom")}),e.CustomCategories=Array.from(i.values()),e}async function n(e,r={URL:"",AutoUpdate:!1,LastCheck:""}){let t;try{t=JSON.parse(e)}catch(e){t={}}let a={ConfigFile:e,ConfigSubscribtion:r,SiteConfig:{SiteName:process.env.NEXT_PUBLIC_SITE_NAME||"MoonTV",Announcement:process.env.ANNOUNCEMENT||"本网站仅提供影视信息搜索服务，所有内容均来自第三方网站。本站不存储任何视频资源，不对任何内容的准确性、合法性、完整性负责。",SearchDownstreamMaxPage:Number(process.env.NEXT_PUBLIC_SEARCH_MAX_PAGE)||5,SiteInterfaceCacheTime:t.cache_time||7200,DoubanProxyType:process.env.NEXT_PUBLIC_DOUBAN_PROXY_TYPE||"melody-cdn-sharon",DoubanProxy:process.env.NEXT_PUBLIC_DOUBAN_PROXY||"",DoubanImageProxyType:process.env.NEXT_PUBLIC_DOUBAN_IMAGE_PROXY_TYPE||"melody-cdn-sharon",DoubanImageProxy:process.env.NEXT_PUBLIC_DOUBAN_IMAGE_PROXY||"",DisableYellowFilter:"true"===process.env.NEXT_PUBLIC_DISABLE_YELLOW_FILTER,FluidSearch:"false"!==process.env.NEXT_PUBLIC_FLUID_SEARCH},UserConfig:{AllowRegister:"true"===process.env.NEXT_PUBLIC_ENABLE_REGISTER,Users:[]},SourceConfig:[],CustomCategories:[]},s=[];try{s=await o.db.getAllUsers()}catch(e){console.error("获取用户列表失败:",e)}let i=s.filter(e=>e!==process.env.USERNAME).map(e=>({username:e,role:"user",banned:!1}));return i.unshift({username:process.env.USERNAME,role:"owner",banned:!1}),a.UserConfig.Users=i,Object.entries(t.api_site||[]).forEach(([e,r])=>{a.SourceConfig.push({key:e,name:r.name,api:r.api,detail:r.detail,from:"config",disabled:!1})}),t.custom_category?.forEach(e=>{a.CustomCategories.push({name:e.name||e.query,type:e.type,query:e.query,from:"config",disabled:!1})}),a}async function c(){if(a)return a;let e=null;try{e=await o.db.getAdminConfig()}catch(e){console.error("获取管理员配置失败:",e)}return e||(e=await n("")),a=e=u(e),o.db.saveAdminConfig(a),a}function u(e){e.UserConfig||(e.UserConfig={AllowRegister:!1,Users:[]}),e.UserConfig.Users&&Array.isArray(e.UserConfig.Users)||(e.UserConfig.Users=[]),e.SourceConfig&&Array.isArray(e.SourceConfig)||(e.SourceConfig=[]),e.CustomCategories&&Array.isArray(e.CustomCategories)||(e.CustomCategories=[]);let r=process.env.USERNAME,t=new Set;e.UserConfig.Users=e.UserConfig.Users.filter(e=>!t.has(e.username)&&(t.add(e.username),!0)),e.UserConfig.Users=e.UserConfig.Users.filter(e=>e.username!==r),e.UserConfig.Users.forEach(e=>{"owner"===e.role&&(e.role="user")}),e.UserConfig.Users.unshift({username:r,role:"owner",banned:!1});let a=new Set;e.SourceConfig=e.SourceConfig.filter(e=>!a.has(e.key)&&(a.add(e.key),!0));let o=new Set;return e.CustomCategories=e.CustomCategories.filter(e=>!o.has(e.query+e.type)&&(o.add(e.query+e.type),!0)),e}async function p(){let e=null;try{e=await o.db.getAdminConfig()}catch(e){console.error("获取管理员配置失败:",e)}e||(e={});let r=await n(e.ConfigFile,e.ConfigSubscribtion);a=r,await o.db.saveAdminConfig(r)}async function l(){return(await c()).SiteConfig.SiteInterfaceCacheTime||7200}async function f(){return(await c()).SourceConfig.filter(e=>!e.disabled).map(e=>({key:e.key,name:e.name,api:e.api,detail:e.detail}))}async function d(e){a=e}},35418:(e,r,t)=>{t.d(r,{D:()=>s});var a=t(2178),o=t.n(a);class s{static encrypt(e,r){try{return o().AES.encrypt(e,r).toString()}catch(e){throw Error("加密失败")}}static decrypt(e,r){try{let t=o().AES.decrypt(e,r).toString(o().enc.Utf8);if(!t)throw Error("解密失败，请检查密码是否正确");return t}catch(e){throw Error("解密失败，请检查密码是否正确")}}static canDecrypt(e,r){try{return this.decrypt(e,r).length>0}catch{return!1}}}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[677,9864,3001,2178,7690],()=>t(8082));module.exports=a})();